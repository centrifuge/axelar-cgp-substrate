//! # Axelar Cross-Chain Gateway Protocol
//!
//! This pallet implements the proof validation logic of the Axelar CGP.
//!
#![cfg_attr(not(feature = "std"), no_std)]

extern crate alloc;

use alloc::boxed::Box;
use ethabi::ethereum_types::H512;
use ethabi::{Address, ParamType, Token};

use sp_core::{keccak_256, H160, H256};
use sp_std::vec::Vec;

// ----------------------------------------------------------------------------
// Custom types and type aliases
// ----------------------------------------------------------------------------
type Bytes = [u8];
type Bytes32 = [u8; 32];
type EthAddress = [u8; 20];

pub struct OperatorsState {
    pub hash: H256,
    pub epoch: u64,
}

/// @dev This function takes messageHash and proof data and reverts if proof is invalid
/// @return True if provided operators are the current ones
/// Original implementation in Solidity:
/// https://github.com/axelarnetwork/axelar-cgp-solidity/blob/main/contracts/auth/AxelarAuthWeighted.sol#L28
pub fn validate(_msg_hash: H256, proof: &Bytes, state: OperatorsState) -> bool {
    // (address[] memory operators, uint256[] memory weights, uint256 threshold, bytes[] memory signatures) = abi.decode(
    //     proof,
    //     (address[], uint256[], uint256, bytes[])
    // );

    // let (operators, weights, threshold, signatures)
    let xs = decode(proof).expect("todo(nuno): return error instead");

    // bytes32 operatorsHash = keccak256(abi.encode(operators, weights, threshold));
    // uint256 operatorsEpoch = epochForHash[operatorsHash];
    // uint256 epoch = currentEpoch;

    //
    // if (operatorsEpoch == 0 || epoch - operatorsEpoch >= OLD_KEY_RETENTION) revert InvalidOperators();
    //
    // _validateSignatures(messageHash, operators, weights, threshold, signatures);
    //
    // return operatorsEpoch == epoch;

    false
}

fn decode(payload: &[u8]) -> Result<Vec<ethabi::Token>, ethabi::Error> {
    ethabi::decode(
        &[
            // operator's addresses
            ParamType::Array(Box::new(ParamType::Address)),
            // weights
            ParamType::Array(Box::new(ParamType::Uint(usize::MAX))),
            // threshold
            ParamType::Uint(usize::MAX),
            // signatures
            ParamType::Array(Box::new(ParamType::Bytes)),
        ],
        payload,
    )
}

// https://github.com/axelarnetwork/axelar-cgp-solidity/blob/main/contracts/auth/AxelarAuthWeighted.sol#L88
// TODO(nuno): given that `operators`, `signatures`, and maybe `weight` should be sorted, I guess
// we could zip the three and pair the computation together instead of the current expensive lookups.
pub fn validate_signatures(
    msg_hash: H256,
    signatures: Vec<Vec<u8>>,
    operators: Vec<Address>,
    weights: Vec<u128>,
    threshold: u128,
) -> bool {
    let mut weight = 0;

    for s in signatures.into_iter() {
        let rsv = to_rsv(s).expect("Todo(nuno): handle");

        let signer = match sp_io::crypto::secp256k1_ecdsa_recover(&rsv, &msg_hash.into()) {
            Ok(pubkey) => H160::from(H256::from_slice(keccak_256(&pubkey).as_slice())),
            Err(_) => return false,
        };

        let index = operators
            .iter()
            .position(|x| x.0 == signer.0)
            .expect("todo(nuno): couldn't find signer");

        weight += weights[index];

        if weight >= threshold {
            return true;
        }
    }

    // In Solidity:
    // if weight sum below threshold
    // revert LowSignaturesWeight();
    false
}

fn to_rsv(signature: Vec<u8>) -> Result<[u8; 65], ()> {
    let src: [u8; 64] = signature.as_slice().try_into().map_err(|_| ())?;

    // Build the `sig` which is of type [0u8; 65]. sig is passed in RSV format. V should be either 0/1 or 27/28.
    let mut rsv = [0u8; 65];
    rsv[0..32].copy_from_slice(&src[0..32]);
    rsv[33..64].copy_from_slice(&src[33..64]);
    rsv[64] = 27;

    Ok(rsv)
}

// ----------------------------------------------------------------------------
// Tests
// ----------------------------------------------------------------------------
#[cfg(test)]
mod tests {
    use super::*;
    use ethabi::Token;
    use sp_std::vec;

    fn encode(
        operators: Vec<[u8; 20]>,
        weights: Vec<u128>,
        threshold: u128,
        signatures: Vec<Vec<u8>>,
    ) -> ethabi::Bytes {
        let operators_token = operators
            .into_iter()
            .map(|x| Token::Address(x.into()))
            .collect();
        let weights_token = weights.into_iter().map(|x| Token::Uint(x.into())).collect();
        let signatures_token = signatures.into_iter().map(|x| Token::Bytes(x)).collect();

        ethabi::encode(&[
            Token::Array(operators_token),
            Token::Array(weights_token),
            Token::Uint(threshold.into()),
            Token::Array(signatures_token),
        ])
    }

    #[test]
    fn proof_encode_decode() {
        let msg_hash = H256::zero();
        let proof = &[1, 2, 3];
        let state = OperatorsState {
            hash: H256::zero(),
            epoch: u64::MAX,
        };

        // Input params
        let operators = vec![[1u8; 20], [2u8; 20]];
        let weights = vec![100, 200];
        let threshold = 99;
        let signatures = vec![vec![1], vec![2]];

        // Encode
        let encoded = encode(
            operators.clone(),
            weights.clone(),
            threshold,
            signatures.clone(),
        );

        // Now decode
        let decoded = decode(&encoded).expect("Should decode");

        if let [Token::Array(operators_token), Token::Array(weights_token), threshold_token, Token::Array(signatures_token)] =
            decoded.as_slice()
        {
            let expected_operators: Vec<Token> = operators
                .into_iter()
                .map(|x| Token::Address(x.into()))
                .collect();
            assert_eq!(operators_token.clone(), expected_operators);

            let expected_weights: Vec<Token> =
                weights.into_iter().map(|x| Token::Uint(x.into())).collect();
            assert_eq!(weights_token.clone(), expected_weights);

            let expected_threshold = Token::Uint(threshold.into());
            assert_eq!(threshold_token.clone(), expected_threshold);

            let expected_signatures: Vec<Token> =
                signatures.into_iter().map(|x| Token::Bytes(x)).collect();
            assert_eq!(signatures_token.clone(), expected_signatures);
        } else {
            panic!("Failed")
        }
    }

    #[test]
    fn test_validate_signatures() {
        let msg_hash = H256::zero();
        let signatures = vec![vec![1; 64], vec![2; 64], vec![3; 64]];
        let operators: Vec<Address> = vec![[1u8; 20].into(), [2u8; 20].into(), [3u8; 20].into()];
        let weights: Vec<u128> = vec![1, 2, 3];
        let threshold = 2;

        assert!(validate_signatures(
            msg_hash, signatures, operators, weights, threshold
        ));
    }

    #[test]
    fn test_decode_input() {
        // from https://polygonscan.com/tx/0x9ee73e51a3b836be02a40b664424c1e7049835fdb101d22d4008b51649fa96fb
        let input = hex::decode("000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000089000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000005835d0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002342a72ea53033aa47c116ea6d92a35259fd85aa0000000000000000000000000000000000000000000000000000000005474568000000000000000000000000000000000000000000000000000000000000000761786c55534443000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001fe00000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000178400000000000000000000000000000000000000000000000000000000000000f80000000000000000000000000000000000000000000000000000000000000003b00000000000000000000000006cef1a89423a4bd1ab859588e7c95e33e5dd5030000000000000000000000002416b62fae3cc9aaaa3d83560faaa099d65b9c6200000000000000000000000025b9437e280fd897e7b92fb969695a9ecfc679a600000000000000000000000025d57ab822c2d16ba0c26b2605204008bb2d5b760000000000000000000000002ab9393d3c4d39fe246f36740e349343aa45926e0000000000000000000000002e0be57ed7d7d0015e15495f5b2cffd1415ca9f40000000000000000000000002f885750185e9b0b50299f67619ccc5029b4fe780000000000000000000000003025973fbc55b3db307b22f5cf950f6e721e1e590000000000000000000000004cfa354d1391366409d8e15cfdaacb548166045300000000000000000000000052ab14b8f00bde612fd3a0efedb874a392e912a100000000000000000000000056a82852cf6fbe733d3bebd203345c8a3af4625f0000000000000000000000005c267d29094484dc6148a314f1da01476e81e3790000000000000000000000005d1bb3c6252377b0fee9a2f5784211e3bf6be9eb0000000000000000000000005f0d2b668452b194da9c4bb44039b46838a7fb4d0000000000000000000000005f709ffda63add6d93f9d5b0d6c8a93687f2060500000000000000000000000063897e57716a3136b367e6b04bdd148bb50743280000000000000000000000006c819a78f2f50957257f3f939533b355b9f53bc10000000000000000000000006c8e5111f0d7fa75f2bbff2c94e3743f4f509c890000000000000000000000006dc62faf15b9c63a30d60e8c51221628cd73441d0000000000000000000000006e9814e6d369d893d178ba086b79cab14456422b000000000000000000000000713643c8fdaf910c92caa2879133d3cf80e47cb7000000000000000000000000766075716f592113e3d89195670c3662b05b71a40000000000000000000000007a05ca9c569695b133c2c3f4363a2f05b87ae40b0000000000000000000000007cd4d2a644f9e480ea5180d8596e98f3bdf4e13900000000000000000000000083166fe68653e9431b36848d59bfaf17aceaed3c0000000000000000000000008b44ba5eb8e346dfe00a413c9d915b07a12b5492000000000000000000000000938e2dd4c5b0082c33d240c551ef7cc4b4bd89cc00000000000000000000000094e610ed1204199b69432a86e5ce2bc09b7b5c8d000000000000000000000000960cb2d7dd310d8f1011fa5e43efbac609e12f6a00000000000000000000000096c71ad79e004d547a6f4a7ca7ceb00e098a75db00000000000000000000000097dc92c1047638ce6cfb1e48680217cbf61605070000000000000000000000009c09e7e02e62d907565a6f8bd9a3f7f9519bb9a60000000000000000000000009ea41855d3caa93e41a7d09dff2161acad20a37f0000000000000000000000009eab40758dd776e32a3beb52c3eadf2d9dc8f59a000000000000000000000000a2f7ec24bf2e5b283d5ede4a70f2010353f43992000000000000000000000000a349424aeb5ebabd27e5ef0e948d1cf4e5bb5c93000000000000000000000000a3f5423cb27974aaa0c3f6626a14d7632ea47e2f000000000000000000000000a8be6d3f1ffa56a41a5e8328ab6684a0a8f3f797000000000000000000000000bb8302cc61bbca73cb5f1e33700b184dd27df39f000000000000000000000000bc550c0a985b8ba108425b81282d240d5efe025b000000000000000000000000be21095401b21b6f96a2f62368f38e374e3cdd4d000000000000000000000000bf1c1bf1135a9a8254af6d54df62acffe403df7d000000000000000000000000c00121d03080a59523397e495453a1bae10ac2ee000000000000000000000000caaacc0c574ed10f513cf4abee0878b80c5b2357000000000000000000000000ce283f39132fd4975d8fc3253f9979c9b614c458000000000000000000000000ce860111db05bd9d62099de889d53e998bbf212d000000000000000000000000d2031ae34371610669a5552e77eb83b2f72401d9000000000000000000000000d5f8c62eba364c3268462648dc1780c65a62f798000000000000000000000000e3a3b4dc387a86ae7b414c1931e17b2cda491b65000000000000000000000000e40ca7c2ddf7d30bdb504bf44e2f7bea087ccb92000000000000000000000000e4b2e50e5a780a3b28029f860101e0d0c64dc448000000000000000000000000e589143e35797e8a6f94d8be3c4dda6e7bc08cba000000000000000000000000e630337486f75373496acb6c25b3990c686637fd000000000000000000000000e7d3711884b278ea71c04ba478b669b0bc1f4501000000000000000000000000eb44d60895554f5bf4bff9734caa648ebf2598ce000000000000000000000000ef40aaa580dd27270cda1a2f58ab133b14d1aa6a000000000000000000000000f21d62e811aa647f8f8bec34acaf48a25a1e8b9a000000000000000000000000f8c8d60dca2de390fe4eda46cf801a46ee6cc529000000000000000000000000fc6f79efe7e3dbb8b63f74c8bf6ffc0225e11bca000000000000000000000000000000000000000000000000000000000000003b000000000000000000000000000000000000000000000000000000000000108d00000000000000000000000000000000000000000000000000000000000008fe0000000000000000000000000000000000000000000000000000000000000c2f0000000000000000000000000000000000000000000000000000000000000d9800000000000000000000000000000000000000000000000000000000000006de0000000000000000000000000000000000000000000000000000000000000e9600000000000000000000000000000000000000000000000000000000000008f10000000000000000000000000000000000000000000000000000000000000c030000000000000000000000000000000000000000000000000000000000000c8e00000000000000000000000000000000000000000000000000000000000002230000000000000000000000000000000000000000000000000000000000000891000000000000000000000000000000000000000000000000000000000000078300000000000000000000000000000000000000000000000000000000000002360000000000000000000000000000000000000000000000000000000000000cd90000000000000000000000000000000000000000000000000000000000000a140000000000000000000000000000000000000000000000000000000000000b0c00000000000000000000000000000000000000000000000000000000000002430000000000000000000000000000000000000000000000000000000000000224000000000000000000000000000000000000000000000000000000000000082600000000000000000000000000000000000000000000000000000000000001d90000000000000000000000000000000000000000000000000000000000000d08000000000000000000000000000000000000000000000000000000000000177500000000000000000000000000000000000000000000000000000000000019ff0000000000000000000000000000000000000000000000000000000000000a4f0000000000000000000000000000000000000000000000000000000000000978000000000000000000000000000000000000000000000000000000000000020f0000000000000000000000000000000000000000000000000000000000000baa0000000000000000000000000000000000000000000000000000000000000bef00000000000000000000000000000000000000000000000000000000000008ad000000000000000000000000000000000000000000000000000000000000058900000000000000000000000000000000000000000000000000000000000009b80000000000000000000000000000000000000000000000000000000000000c650000000000000000000000000000000000000000000000000000000000000dac0000000000000000000000000000000000000000000000000000000000000bc4000000000000000000000000000000000000000000000000000000000000118500000000000000000000000000000000000000000000000000000000000007b1000000000000000000000000000000000000000000000000000000000000103f000000000000000000000000000000000000000000000000000000000000022a0000000000000000000000000000000000000000000000000000000000000227000000000000000000000000000000000000000000000000000000000000098c00000000000000000000000000000000000000000000000000000000000005860000000000000000000000000000000000000000000000000000000000000bf90000000000000000000000000000000000000000000000000000000000000fea00000000000000000000000000000000000000000000000000000000000004c80000000000000000000000000000000000000000000000000000000000000f990000000000000000000000000000000000000000000000000000000000000c8500000000000000000000000000000000000000000000000000000000000006c00000000000000000000000000000000000000000000000000000000000000c2c00000000000000000000000000000000000000000000000000000000000006f70000000000000000000000000000000000000000000000000000000000000a220000000000000000000000000000000000000000000000000000000000000f3a00000000000000000000000000000000000000000000000000000000000008710000000000000000000000000000000000000000000000000000000000000cbc000000000000000000000000000000000000000000000000000000000000098900000000000000000000000000000000000000000000000000000000000013fa0000000000000000000000000000000000000000000000000000000000000f3f0000000000000000000000000000000000000000000000000000000000000d8300000000000000000000000000000000000000000000000000000000000004cc0000000000000000000000000000000000000000000000000000000000000c6c000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000004c0000000000000000000000000000000000000000000000000000000000000054000000000000000000000000000000000000000000000000000000000000005c0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000007c0000000000000000000000000000000000000000000000000000000000000084000000000000000000000000000000000000000000000000000000000000008c0000000000000000000000000000000000000000000000000000000000000094000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000000ac00000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000bc00000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000d400000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000000e400000000000000000000000000000000000000000000000000000000000000ec00000000000000000000000000000000000000000000000000000000000000f400000000000000000000000000000000000000000000000000000000000000fc000000000000000000000000000000000000000000000000000000000000000413d6d4ed3c1bfc3d5eee308d63c5f565cfc0fd5112c24af139bcd726bc4879fd80695076bf6964d03b2e652d58114c3b7e3958a9d44fa4ca623abc5cd506193c31b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041cba9ca7a3d269fb7164e2fbe2db9502f9c4761d5925efecb9d3a0d4560ad13ef62c4bf55bcd00d71cb965614e647c32016655d85b90300bb38668516090bc83f1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000419d02b04c36dc9720334cfc93402b3ec7d67d509193ca84582a3a313579e48b1537e6ad6cf34c4e6d97abd691ab0e00e6b44fd8f8c335aa16601e7b3ef57964a61b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004105fccfda2dac5e453371c395650dbed14bcb06d5796a99d2d79ad289927dc921019f81bde74e00fb40d83b5eb01f1d641ba61a915526aaf6142665a1c15279cd1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ed9102a789964ab9f7d82c7600429fddf694387a9cf2f2352e45aaf525e9ba2a72abb52a2ee94c75b22208babaac8653d07323a4fb92c29e0cee9cb451e4f3e31b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004165500508c0bd501a790d5c95e63e28b07b90ee2e23a67143df9f691f9e03551505121504cf840365cfa4d19a8a92c1ad2974e94f12fa60445a8e53855390612c1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000417e9abb4c4944053e2c1e8db75536745ca476bf9cc0b8917f0a855476d8b402ef06d4921e61f0479203b34f7e1344d4d7aae2349092fa737e5385c772696deca81b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000414142fec1a97074148ea64ab9d8ff9974389e577b70f3ac2909a8a275ef718c536afbca6a884f0dbbf11823d9bf3366864e8b8c8624f9d6f1b8e966619dfc01201c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ece11737425a5a7fa8cbe30683db2ae6d3d53ebe90a6ee3b3c36bce6758a487e77a759f197f3950375df647b10a9d4b6850e030372552547ca76d1f85a3c4e9b1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041986ca2335d56acd00b7f90f10e3ec047ad104958ea588dbe002e9fe08688bba710e351837efb8b82eefc0d9b86ea82bcd3a2e2be32635e814b344d76075d13121b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041d3c27c357f487eb8d7b10b9f7e6898c96351c66f9fea23e9578fb0d1c1743a791f5c92bcfc6bf85251b61e000b35fa8998d8b7fbd493b58ca4e178a5be3f9f921b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ed99c6e5a24010e558c74121358aa31bb1f6ca88af14d920ae916376c0a5e47b1b8b0c3a0fd91c3a8ef6d1ab180fb93e552cb16c382b78911f1a87c31642637f1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000410ba100d22e89cfe934fb0de9fc18f71f8f7daf34866d1cac2c3b5595eaa1af1d17f46b87b72260982b53f5882c530f66d1b50bf525a88a968244b571fd9a302f1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000417fec99b6f5dbc03c532a2d365df35f05c8effb6d4efc624244360338a8a8e87a6bd33b7f9a695efe41b5eea3cba51fba27462c3a345370c654067194761e4eac1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000413c07fd83a14f5d857392bd541a8441c87c8c849f0892cc246bfe4d8b17699bb130b09dfe10d24c61280745064bee9d4ccf3aab593a8957273a67b83036213de51c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f5ad015383a666c9775922a0567edfe448ee34dc44484874056be9991da277b5412ce1db99304c01fb0b2a230b58a45c5d265aa49452028ba5e6b96b7185cf831c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041b5956bdb0b107fa43db9d7a927c69b1ec7552d822c5745bb04464d61ccd4a4c4548f2d277e63052d6005e909cbce12f5096d0b12b9c7b240313279b1495cb88c1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000419a66a1dc86edc187ecdbb3bcdfedec067d1f27ed546302ad6781fe6e790636fa13e82c0085e58e6bfdc609d74cf69c29acab19cd010cf1d0323515bd2bccfd881b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041a646b33a1d20a8e24bd94e5dca706a6acaa27089c76f98939bc3cc3f9206c55e1c8ab66638662eb4d57b80db05590cf7c9fed43cc51da2c4bc8d9af8e557a23b1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041177b28d957873e9f43ff19bf208e5ccd11c676ddfd3b404199ae2242a7d1d55c0f835ad2d0a8d8fe3556104cfee080035ec3896be247376591deb6daf24d301e1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041e442a717d87dea0ab50d3d9ae873f1fbc96cf7f3242a3520b30a9cfb1811ed97570b9330a2a96ecb3864e12d2818e0b2b8533b4c2b605f692b9207bcd9c230fc1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004166653719942c8f08fa39d210b1350ec556aef3064f633df7ca4b5097d230c3b9240fcf4af1a7ffcf005d67b661062866ed7dbc9afaaa35b54d30f3b2adbb68fb1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041336175e7f6396ad8f80c9f0ab2020368388212622d204457e7dcfd65ca5f9a1b74665c41097ef653beb86765ff6638e965508811512dab844bb2498ea470db8b1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bd24c6f913acc9f6a74c6c8fc3d515a777517f89deaa43b7baf4f6eec9ae71e67e4ce077855398b33e39b25e60a975b5b477d306255868787b2a2b350145e39a1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041dbca1a104ae7559d72e2e4943f57fd95a2492435a48af96eeaf6f20e9b311a183d0f69ec8b206111361d29cd4f2ee0046314b10817dead2a04e6f63c91e891971c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041955bfe3d908a4227f437555ca9a213be8b97b02e213f3a7df8ecb9be3622758a6b800e1a69cf636c337c94d6ac431b22cb494d34b0684a85bc350c87bd69bfbe1b00000000000000000000000000000000000000000000000000000000000000").expect("bad input");

        let x = decode_input(&input);
        assert!(x.is_ok());
    }
}

fn decode_input(input: &[u8]) -> Result<(Vec<u8>, Vec<u8>), ethabi::Error> {
    let res = ethabi::decode(
        &[
            // data
            ParamType::Bytes,
            // proof
            ParamType::Bytes,
        ],
        input,
    );

    match res {
        Ok(params) => match params.as_slice() {
            [Token::Bytes(data), Token::Bytes(proof)] => Ok((data.clone(), proof.clone())),
            _ => panic!("todo(nuno): wrong input"),
        },
        _ => panic!("todo(nuno): failed to decode input"),
    }
}
